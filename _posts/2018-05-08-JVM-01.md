---
layout:     post
title:      深度理解 JVM 一
subtitle:   JVM 类加载机制 😅
date:       2018-05-08
author:     BY Malcolmszx
header-img: img/post-bg-ios10.jpg
catalog: true
tags:
    - JVM
---

# jvm系列(一) : java类的加载机制

## 类型加载概念

类加载指的是将类的.class文件中的二进制数据读入到内存中，将其放在运行时数据区的方法区内，然后在堆内存创建一个java.lang.class对象，用来封装类在方法区内的数据结构。类加载的最终产品是位于堆区中的class对象，class对象封装了类在方法区内的数据结构，并且向java程序员提供了访问方法区的数据结构的接口。

![](https://mmbiz.qpic.cn/mmbiz_png/PgqYrEEtEnokxXiapDdvntH8PGwa0zGXMqaq9p1LDCF7iadMBibd685uYCy8u0yhb5dmlvLRwgzNueNdSdWdvEwww/0?wx_fmt=png)

类加载并不需要等到某个类被"首次主动使用"时再加载它，JVM规范允许类加载器在预料某个类将要被使用时就预先加载它，如果在预先加载的过程中遇到了.class 文件缺失或存在错误，类加载器必须在程序首次主动使用该类时才报告错误（LinkageError错误）如果这个类一直没有被程序主动使用，那么类加载器就不会报告错误。

**加载.class文件的方式**

- 从本地系统中直接加载

- 通过网络下载.class文件

- 从zip，jar等归档文件中加载.class文件

- 从专有数据库中提取.class文件

- 将Java源文件动态编译为.class文件

## 类的生命周期

![](http://img.blog.csdn.net/20140317163048593)

其中类加载的过程包括了加载、验证、准备、解析及初始化五个阶段。其中加载、验证、准备和初始化这四个阶段发生的顺序是确定的，而解析阶段则不一定，它在某些情况下可以在初始化阶段之后开始，这是为了支持Java语言的运行时绑定（也成为动态绑定或晚期绑定）。另外注意这里的几个阶段是按顺序开始，而不是按顺序进行或完成，因为这些阶段通常都是互相交叉地混合进行的，通常在一个阶段执行的过程中调用或激活另一个阶段。

**加载**

查找并加载类的二进制数据加载时类加载过程的第一个阶段，在加载阶段，虚拟机需要完成以下三件事情：

1. 通过一个类的全限定名来获取其定义的二进制字节流。

2. 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。

3. 在Java堆中生成一个代表这个类的 java.lang.Class对象，作为对方法区中这些数据的访问入口。

相对于类加载的其他阶段而言，加载阶段（准确地说，是加载阶段获取类的二进制字节流的动作）是可控性最强的阶段，因为开发人员既可以使用系统提供的类加载器来完成加载，也可以自定义自己的类加载器来完成加载。

加载阶段完成后，虚拟机外部的二进制字节流就按照虚拟机所需的格式存储在方法区之中，而且在Java堆中也创建一个 java.lang.Class类的对象，这样便可以通过该对象访问方法区中的这些数据。

**连接**

### 验证：确保被加载的类的正确性

验证是连接阶段的第一步，目的是确保class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。验证阶段包括以下几个过程：

- 文件格式验证：验证字节流是否符合class文件格式的规范；例如：是否以0xCAFEBABE开头，主次版本号是否在当前虚拟机的处理范围之内、常量池中的常量是否有不被支持的类型。

- 元数据验证：对字节码描述的信息进行语义分析（注意：对比javac编译阶段的语义分析），以保证其描述的信息符合Java语言规范的要求；例如：这个类是否有父类，除了 java.lang.Object之外。

- 字节码验证：通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。

- 符号引用验证：确保解析动作能正确执行。

验证阶段是非常重要的，但不是必须的，它对程序运行期没有影响，如果所引用的类经过反复验证，那么可以考虑采用 -Xverifynone参数来关闭大部分的类验证措施，以缩短虚拟机类加载的时间。

### 准备：为类的静态变量分配内存，并将其初始化为默认值

准备阶段是正式为类变量分配内存比设置类变量初始值的阶段，这些内存都将在方法区中分配。对于该阶段有以下几点需要注意：






