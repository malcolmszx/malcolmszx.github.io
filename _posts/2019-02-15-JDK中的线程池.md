---
layout:     post
title:  如何掌握JDK中的线程池
subtitle:  JDK中的线程池
date:       2019-02-15
author:     BY Malcolmszx@gmail.com
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - JDK
    - ThreadPoolExecutor 
---

## 前言

JDK并发包下面的线程池ThreadPoolExecutor是面试中经常被考查的点，ThreadPoolExecutor哪些是应该掌握的？下面抛出了几个问题。

1. ThreadPoolExecutor中常用参数有哪些，作用是什么？任务提交后，ThreadPoolExecutor会按照什么策略去创建线程用于执行提交任务？
2. ThreadPoolExecutor有哪些状态，状态之间是怎样流转的？
3. ThreadPoolExecutor线程哪个时间点被创建？是任务提交后吗？可以在任务提交前创建吗？
4. ThreadPoolExecutor创建的线程哪个时间被启动？
5. ThreadPoolExecutor竟然是线程池那么他是如何做到重复利用线程的？
6. ThreadPoolExecutor创建的同一个线程同一时刻能执行多个任务吗？如果不能是通过什么机制保证ThreadPoolExecutor中的同一个线程只能执行完一个任务，才会执行另一个任务？
7. ThreadPoolExecutor关闭线程池的方法shutdown与shutdownNow的区别是什么？
8. 通过submit方法向ThreadPoolExecutor提交任务后，当所有的任务都执行完后不调用shutdown或shutdownNow方法有问题？
9. ThreadPoolExecutor有没有提供扩展点，方便在任务执行前或执行后做一些事情？

### ThreadPoolExecutor参数有哪些与创建线程策略

ThreadPoolExecutor参数

1. corePoolSize 线程池中核心线程数
2. maximumPoolSize 线程池中最大线程数
3. keepAliveTime 当线程池中线程数量超过corePoolSize时，允许等待多长时间从workQueue中拿任务
4. unit keepAliveTime对应的时间单位，为TimeUnit类。
5. workQueue 阻塞队列，当线程池中线程数超过corePoolSize时，用于存储提交的任务。
6. threadFactory 线程池采用，该线程工厂创建线程池中的线程。
7. handler 为RejectedExecutionHandler，当线程线中线程超过maximumPoolSize时采用的，拒绝执行处理器。

创建线程策略

[![](https://blogimg-1256334314.cos.ap-chengdu.myqcloud.com/367eb895-6d1d-40ec-858e-755796aa97d6.png)](https://malcolmszx.github.io/)

简单介绍一下，一个任务提交给线程池后，线程池创建线程来执行提交任务的流程。

1. 当提交任务时线程池中的来用执行任务的线程数小于corePoolSize（核心线程数），则线程池利用ThreadFacory（线程工厂）创建线程用于执行提交的任务。否则执行第二2步。
2. 当提交任务时线程池中的来用执行任务的线程数大于corePoolSize（核心线程数），但workQueue没有满，则线程池会将提交的任务先保存在workQueue（工作队列），等待线程池中的线程执行完其它已提交任务后会循环从workQueue中取出任务执行。否则执行第3步。
3. 当提交任务时线程池中的来用执行任务大于corePoolSize（核心线程数），且workQueu已满，但没有超过maximunPoolSize（最大线程数），则线程池利用ThreadFacory（线程工厂）创建线程用于执行提交的任务。否则执行4。
4. 当提交任务时线程池中的来用执行任务大于maximunPoolSize，执行线程池中配置的拒绝策略（RejectedExecutionHanlder）。
所以在设置ThreadPoolExecutor的参数时一定要特别小心，不建议采用很大的ArrayBlockQueue或不限大小的LinkedBlockQueue，同时corePoolSize也不应该设置过大。CUP密集的任务的话可以设置小一点(CUP数据+1这种)避免不必要的上下文切换；而对于IO密集的任务则corePoolSize则可以设置的大一点，可以避免长时间IO等待而CUP却空闲。threadFactory建议采用自己定义的，让其创建的线程容易区分，方便问题定位。